<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¥ç¸äººæ ¼ Ã— æ€§æ„›äº”è¡Œä¸­åº¸åˆ†æ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    #congratsPopup { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 50; background: rgba(0,0,0,0.5); }
    #congratsPopup .box { background: white; padding: 2rem; border-radius: 1rem; text-align: center; animation: pop 0.5s ease; }
    @keyframes pop { from { transform: scale(0.5); opacity:0; } to { transform: scale(1); opacity:1; } }
    .confetti { position: absolute; width: 10px; height: 20px; opacity: 0.8; animation: fall 3s linear infinite; }
    @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }

    /* æ°´æ™¶çƒå‹•ç•« */
    .crystal-ball {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 6px solid rgba(255,255,255,0.8);
      background: radial-gradient(circle at 30% 30%, #fbcfe8, #f472b6, #a78bfa);
      animation: spin 2s linear infinite;
      margin: 0 auto 20px auto;
      box-shadow: 0 0 25px rgba(244,114,182,0.8);
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="p-6 bg-gradient-to-b from-pink-100 to-red-100 min-h-screen">

  <!-- å›é¦–é  -->
  <div class="mb-6 text-center">
    <a href="index.html" class="bg-gray-600 text-white px-4 py-2 rounded shadow hover:bg-gray-700">
      â¬…ï¸ å›é¦–é 
    </a>
  </div>

  <h1 class="text-3xl font-bold text-center text-red-600 mb-6">AI åŠ‡æœ¬åˆ†æ</h1>

  <!-- Aæ–¹ -->
  <div class="bg-white shadow p-4 rounded-xl mb-4">
    <h2 class="font-bold mb-2">Aæ–¹</h2>
    <select id="aBeast"></select>
    <select id="aKin"></select>
    <select id="aBranch"></select>
  </div>

  <!-- Bæ–¹ -->
  <div class="bg-white shadow p-4 rounded-xl mb-4">
    <h2 class="font-bold mb-2">Bæ–¹</h2>
    <select id="bBeast"></select>
    <select id="bKin"></select>
    <select id="bBranch"></select>
  </div>

  <!-- æ—¥æœˆæ”¯ -->
  <div class="bg-white shadow p-4 rounded-xl mb-6">
    <label>æ—¥æ”¯ <select id="dayBranch"></select></label>
    <label class="ml-4">æœˆæ”¯ <select id="monthBranch"></select></label>
  </div>

  <div class="text-center mb-6">
    <button id="analyzeBtn" class="bg-red-600 text-white px-6 py-3 rounded-xl shadow-lg hover:bg-red-700 transition">
      ğŸš€ é–‹å§‹åˆ†æ
    </button>
  </div>

  <!-- åˆ†æé€²åº¦ -->
  <div id="loadingSection" class="hidden text-center mb-6">
    <div class="crystal-ball"></div>
    <p class="text-lg font-semibold text-gray-700 mb-2">ğŸ”® æ­£åœ¨åˆ†æä¸­ï¼Œè«‹ç¨å€™...</p>
    <div class="w-full bg-gray-200 rounded-full h-4 max-w-lg mx-auto">
      <div id="loadingBar" class="bg-pink-500 h-4 rounded-full text-xs text-white text-right pr-2" style="width:0%">0%</div>
    </div>
  </div>

  <!-- çµæœ -->
  <div id="result" class="hidden mt-6 bg-white shadow-lg rounded-xl p-6">
    <div class="mb-6">
      <canvas id="loveChart" width="400" height="400"></canvas>
    </div>
    <div class="mb-6">
      <label class="font-bold">å¥‘åˆåº¦ï¼š</label>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div id="matchBar" class="bg-green-500 h-4 rounded-full text-right pr-2 text-xs text-white">0%</div>
      </div>
    </div>
    <div id="analysisText" class="prose max-w-none"></div>
  </div>

  <!-- æ­å–œå½ˆçª— -->
  <div id="congratsPopup" class="flex">
    <div class="box">
      <h2 class="text-2xl font-bold text-green-600">ğŸ‰ æ­å–œï¼</h2>
      <p class="mt-2">èƒ½é‡å¥‘åˆåº¦æ¥µé«˜ï¼Œä»Šæ™šæœ€ä½³æ‹æª”ï¼</p>
    </div>
  </div>

  <!-- éŸ³æ•ˆ -->
  <audio id="goodMusic" src="good.mp3"></audio>
  <audio id="badMusic" src="bad.mp3"></audio>

  <script>
    const beasts = ["é’é¾","æœ±é›€","å‹¾é™³","è£è›‡","ç™½è™","ç„æ­¦"];
    const kins = ["çˆ¶æ¯","å…„å¼Ÿ","å¦»è²¡","å®˜é¬¼","å­å­«","æ‡‰ä½"];
    const branches = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];

    function fillSelect(select, options) {
      select.innerHTML = options.map(o => `<option value="${o}">${o}</option>`).join("");
    }

    // åˆå§‹åŒ–
    fillSelect(aBeast, beasts);
    fillSelect(bBeast, beasts);
    fillSelect(aKin, kins);
    fillSelect(bKin, kins);
    fillSelect(aBranch, branches);
    fillSelect(bBranch, branches);
    fillSelect(dayBranch, branches);
    fillSelect(monthBranch, branches);

    // äº’æ–¥è™•ç†
    function updateOptions() {
      const aBeastVal = aBeast.value;
      const bBeastVal = bBeast.value;
      const aKinVal = aKin.value;
      const bKinVal = bKin.value;

      fillSelect(aBeast, beasts.filter(b => b !== bBeastVal));
      fillSelect(bBeast, beasts.filter(b => b !== aBeastVal));
      aBeast.value = aBeastVal;
      bBeast.value = bBeastVal;

      fillSelect(aKin, kins.filter(k => k !== bKinVal));
      fillSelect(bKin, kins.filter(k => k !== aKinVal));
      aKin.value = aKinVal;
      bKin.value = bKinVal;
    }

    aBeast.addEventListener("change", updateOptions);
    bBeast.addEventListener("change", updateOptions);
    aKin.addEventListener("change", updateOptions);
    bKin.addEventListener("change", updateOptions);

    let chart;

    document.getElementById("analyzeBtn").addEventListener("click", async ()=>{
      const payload = {
        aBeast: aBeast.value, aKin: aKin.value, aBranch: aBranch.value,
        bBeast: bBeast.value, bKin: bKin.value, bBranch: bBranch.value,
        dayBranch: dayBranch.value, monthBranch: monthBranch.value
      };

      const loadingSection = document.getElementById("loadingSection");
      const loadingBar = document.getElementById("loadingBar");
      const outputDiv = document.getElementById("analysisText");

      document.getElementById("result").classList.add("hidden");
      loadingSection.classList.remove("hidden");

      // å‹•æ…‹é€²åº¦æ¢æ¨¡æ“¬
      let progress = 0;
      const interval = setInterval(()=>{
        if(progress < 95){
          progress += Math.floor(Math.random()*5)+1;
          if(progress>95) progress=95;
          loadingBar.style.width = progress+"%";
          loadingBar.innerText = progress+"%";
        }
      }, 200);

      try {
        const res = await fetch("/api/analyze", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        clearInterval(interval);
        loadingBar.style.width = "100%";
        loadingBar.innerText = "100%";

        setTimeout(()=>{
          loadingSection.classList.add("hidden");
          document.getElementById("result").classList.remove("hidden");

          outputDiv.innerHTML = data.text ? marked.parse(data.text) : "âš ï¸ æ²’æœ‰æ”¶åˆ°åˆ†æå…§å®¹";

          if(chart) chart.destroy();
          chart = new Chart(document.getElementById("loveChart"),{
            type:"radar",
            data:{ labels:["æƒ…æ…¾(ç«)","æƒ…æ„Ÿ(æ°´)","æ§åˆ¶(åœŸ)","å†’éšª(é‡‘)","å‰µæ„(æœ¨)"],
              datasets:[{ label:"æ€§æ„›èƒ½é‡", data:data.scores||[20,20,20,20,20],
                backgroundColor:"rgba(255,99,132,0.2)", borderColor:"rgb(255,99,132)" }] }
          });

          const bar = document.getElementById("matchBar");
          const match = data.match || 0;
          bar.style.width = match + "%";
          bar.innerText = match + "%";
          bar.className = "h-4 rounded-full text-right pr-2 text-xs text-white " +
            (match >= 80 ? "bg-green-500" : match >= 50 ? "bg-yellow-500" : "bg-red-500");

          if(match >= 80){ playMusic("good"); showCongrats(); }
          else if(match < 50){ playMusic("bad"); }

        }, 600);

      } catch(err){
        clearInterval(interval);
        loadingSection.classList.add("hidden");
        outputDiv.innerHTML = "âŒ éŒ¯èª¤ï¼š" + err.message;
      }
    });

    function showCongrats(){
      const popup=congratsPopup;
      popup.style.display="flex";
      for(let i=0;i<30;i++){
        const c=document.createElement("div");
        c.className="confetti";
        c.style.left=Math.random()*100+"vw";
        c.style.background=["#f87171","#34d399","#60a5fa","#fbbf24","#a78bfa"][Math.random()*5|0];
        c.style.animationDuration=(2+Math.random()*3)+"s";
        popup.appendChild(c);
        setTimeout(()=>c.remove(),3000);
      }
      setTimeout(()=>{popup.style.display="none";},5000);
    }

    function playMusic(type){
      goodMusic.pause(); badMusic.pause();
      if(type==="good"){goodMusic.currentTime=0;goodMusic.play();}
      else{badMusic.currentTime=0;badMusic.play();}
    }
  </script>
</body>
</html>
