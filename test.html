<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>18ç¦å¥‘åˆåº¦æ¸¬è©¦</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.1/html-docx.js"></script>
  <style>
    .loading-dots::after { content: '...'; animation: dots 1.5s steps(3, end) infinite; }
    @keyframes dots {
      0%,20% { content:'' } 40% { content:'.' } 60% { content:'..' } 80%,100% { content:'...' }
    }
  </style>
</head>
<body class="bg-gradient-to-b from-gray-50 to-pink-100 text-gray-800 min-h-screen flex flex-col items-center py-10">

  <h1 class="text-3xl font-bold text-pink-700 mb-6">ğŸ”® å¥‘åˆåº¦åˆ†æç³»çµ±</h1>

  <!-- ä»Šæ—¥è¾²æ›†èˆ‡ç¯€æ°£è³‡è¨Š -->
  <div class="p-4 mb-6 bg-pink-50 border border-pink-200 rounded-lg shadow w-3/4">
    <div id="lunar-date" class="text-pink-700 font-bold"></div>
    <div id="gan-zhi" class="text-gray-700 mt-1"></div>
    <div id="season-name" class="text-lg font-semibold text-pink-600 mt-2"></div>
    <div id="season-desc" class="text-gray-600"></div>
    <div id="season-advice" class="text-green-700 mt-1"></div>
  </div>

  <!-- A æ–¹ / B æ–¹ -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 w-3/4">
    <div class="p-4 bg-white rounded-xl shadow">
      <h2 class="font-bold text-lg mb-2 text-pink-600">A æ–¹</h2>
      <select id="aBeast" class="w-full border p-2 rounded mb-2">
        <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
        <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
      </select>
      <select id="aKin" class="w-full border p-2 rounded mb-2">
        <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å¦»è²¡</option>
        <option>å®˜é¬¼</option><option>å­å­«</option>
      </select>
      <select id="aBranch" class="w-full border p-2 rounded"></select>
    </div>
    <div class="p-4 bg-white rounded-xl shadow">
      <h2 class="font-bold text-lg mb-2 text-pink-600">B æ–¹</h2>
      <select id="bBeast" class="w-full border p-2 rounded mb-2">
        <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
        <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
      </select>
      <select id="bKin" class="w-full border p-2 rounded mb-2">
        <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å¦»è²¡</option>
        <option>å®˜é¬¼</option><option>å­å­«</option>
      </select>
      <select id="bBranch" class="w-full border p-2 rounded"></select>
    </div>
  </div>

  <!-- æœˆæ”¯ / æ—¥æ”¯ -->
  <div class="flex gap-4 mb-4">
    <div>
      <label class="font-bold">æœˆæ”¯ï¼š</label>
      <select id="monthBranch" class="border p-2 rounded"></select>
    </div>
    <div>
      <label class="font-bold">æ—¥æ”¯ï¼š</label>
      <select id="dayBranch" class="border p-2 rounded"></select>
    </div>
  </div>

  <!-- åˆ†ææŒ‰éˆ• -->
  <button onclick="startAnalysis()"
          class="mb-6 px-8 py-4 bg-pink-500 text-white text-lg rounded-2xl shadow hover:bg-pink-600 transition">
    ğŸš€ é–‹å§‹åˆ†æ
  </button>

  <!-- é€²åº¦æ¢ -->
  <div class="w-3/4 bg-gray-200 rounded-full h-6 mb-4">
    <div id="progress-bar" class="bg-pink-500 h-6 rounded-full text-white text-sm flex items-center justify-center"
         style="width:0%">0%</div>
  </div>
  <p id="loading-text" class="text-pink-600 font-bold mb-4"></p>

  <!-- å¥‘åˆåº¦ -->
  <div class="w-3/4 bg-white shadow rounded-xl p-4 mb-4">
    <p class="font-bold mb-2">å¥‘åˆåº¦ï¼š</p>
    <div class="w-full bg-gray-200 rounded-full h-4">
      <div id="match-bar" class="bg-green-500 h-4 rounded-full text-xs text-white text-right pr-2">0%</div>
    </div>
  </div>

  <!-- é›·é”åœ– -->
  <div class="w-3/4 bg-white shadow rounded-xl p-4 mb-4">
    <h3 class="font-bold text-pink-600 mb-2">äº”è¡Œèƒ½é‡åœ–</h3>
    <canvas id="loveChart" width="400" height="400"></canvas>
  </div>

  <!-- åˆ†æçµæœ -->
  <div id="result" class="w-3/4 bg-white shadow rounded-xl p-4 text-gray-700"></div>

  <!-- åŒ¯å‡ºæŒ‰éˆ• -->
  <div id="download-section" class="mt-4 hidden flex gap-4">
    <button id="downloadWord" class="px-4 py-2 bg-blue-500 text-white rounded">ğŸ“„ ä¸‹è¼‰ Word</button>
    <button id="downloadPdf" class="px-4 py-2 bg-green-600 text-white rounded">ğŸ“• ä¸‹è¼‰ PDF</button>
  </div>

  <!-- è²éŸ³ -->
  <audio id="success-audio" hidden><source src="pic/success.mp3" type="audio/mpeg"></audio>
  <audio id="fail-audio" hidden><source src="pic/fail.mp3" type="audio/mpeg"></audio>

<script>
const branches = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
function fillSelect(id, arr){ document.getElementById(id).innerHTML=arr.map(x=>`<option>${x}</option>`).join(""); }
fillSelect("aBranch", branches); fillSelect("bBranch", branches); fillSelect("dayBranch", branches); fillSelect("monthBranch", branches);

// é è¨­ä»Šå¤©çš„æ—¥æ”¯ & æœˆæ”¯
const today = new Date();
document.getElementById("dayBranch").value = branches[today.getDate()%12];
document.getElementById("monthBranch").value = branches[today.getMonth()%12];

// ===== è¾²æ›† =====
async function fetchLunarDate(y,m,d){
  try{
    const r=await fetch(`https://lunar-calendar-api.netlify.app/v0/2/g2l?y=${y}&m=${m}&d=${d}&z=8&lang=zh`);
    const data=await r.json();
    document.getElementById("lunar-date").innerText = "ğŸ“… è¾²æ›†ï¼š" + data.text;

    const yearMatch=data.text.match(/(.{2})å¹´/);
    const monthMatch=data.text.match(/(.{2})æœˆ/);
    const dayMatch=data.text.match(/(.{2})æ—¥/);
    let yearGanZhi=yearMatch?yearMatch[1]:"æœªçŸ¥";
    let monthGanZhi=monthMatch?monthMatch[1]:"æœªçŸ¥";
    let dayGanZhi=dayMatch?dayMatch[1]:"æœªçŸ¥";

    document.getElementById("gan-zhi").innerText=`ğŸ§­ å¹²æ”¯ï¼š${yearGanZhi}å¹´ ${monthGanZhi}æœˆ ${dayGanZhi}æ—¥`;
    window.lunarData={yearGanZhi,monthGanZhi,dayGanZhi,lunarText:data.text};
  }catch{
    document.getElementById("lunar-date").innerText=`ğŸ“… è¾²æ›†ï¼š${y}å¹´${m}æœˆ${d}æ—¥ï¼ˆå‡è³‡æ–™ï¼‰`;
    document.getElementById("gan-zhi").innerText="ğŸ§­ å¹²æ”¯ï¼šç”²å­å¹´ ç”²å­æœˆ ç”²å­æ—¥";
  }
}
fetchLunarDate(today.getFullYear(),today.getMonth()+1,today.getDate());

// ===== ç¯€æ°£ =====
const jieqi=[
  { name:"ç«‹æ˜¥",date:"2025-02-03",desc:"æ˜¥å›å¤§åœ°ï¼Œè¬ç‰©èŒèŠ½ã€‚",advice:"å¤šæ¥è§¸é™½å…‰ï¼Œåˆ¶å®šå°ç›®æ¨™ã€‚" },
  { name:"é›¨æ°´",date:"2025-02-18",desc:"å†°é›ªæ¶ˆèï¼Œé›¨æ°´æ¼¸å¤šã€‚",advice:"ä¿æŒé‹å‹•èˆ‡è¦å¾‹ä½œæ¯ã€‚" },
  { name:"é©šèŸ„",date:"2025-03-05",desc:"æ˜¥é›·ä¹éŸ¿ï¼Œè¬ç‰©ç”¦é†’ã€‚",advice:"ç”¨å¯«æ—¥è¨˜ã€æ·±å‘¼å¸æ–¹å¼å¹³ç©©å…§å¿ƒã€‚" },
  { name:"æ˜¥åˆ†",date:"2025-03-20",desc:"æ™å¤œå‡åˆ†ï¼Œé™°é™½å¹³è¡¡ã€‚",advice:"é©åˆéœåã€èŒ¶é£²ï¼Œä¿æŒå…§å¤–å’Œè«§ã€‚" },
  { name:"æ¸…æ˜",date:"2025-04-04",desc:"æ˜¥æš–èŠ±é–‹ï¼Œæ…çµ‚è¿½é ã€‚",advice:"é€éæƒå¢“ç¥­ç¥–è½‰åŒ–æƒ…ç·’ã€‚" },
  { name:"ç©€é›¨",date:"2025-04-20",desc:"é›¨ç”Ÿç™¾ç©€ï¼Œè¬ç‰©èŒ‚ç››ã€‚",advice:"ç·´ç¿’è€å¿ƒï¼Œçµ¦è‡ªå·±æ™‚é–“é†é‡€æˆæœã€‚" },
  { name:"ç«‹å¤",date:"2025-05-05",desc:"å¤å­£ä¼Šå§‹ï¼Œé™½æ°£æ¼¸ç››ã€‚",advice:"ä¿æŒé£²é£Ÿæ¸…æ·¡ï¼Œé©åº¦é‹å‹•ã€‚" },
  { name:"å°æ»¿",date:"2025-05-21",desc:"ç©€ç‰©æ¼¸æ»¿ï¼Œé™½å…‰å……è¶³ã€‚",advice:"ä¿æŒè¬™éœï¼Œç¹¼çºŒé€²æ­¥ã€‚" },
  { name:"èŠ’ç¨®",date:"2025-06-05",desc:"è¾²å¿™æ™‚ç¯€ï¼Œæ”¶ç©«é–‹å§‹ã€‚",advice:"èª¿æ•´å‘¼å¸ï¼Œå°ˆæ³¨ç•¶ä¸‹ã€‚" },
  { name:"å¤è‡³",date:"2025-06-21",desc:"ç™½æ™æœ€é•·ï¼Œé™½æ¥µä¹‹æ™‚ã€‚",advice:"æ—©ç¡æ—©èµ·ï¼Œä¿æŒæ¶¼çˆ½å¿ƒå¢ƒã€‚" },
  { name:"å°æš‘",date:"2025-07-07",desc:"æ°£æº«ä¸Šå‡ï¼Œæš‘æ°£åˆè‡¨ã€‚",advice:"å¤šå–æ°´ï¼Œå°‘çˆ­è¾¯ï¼Œå¤šç†è§£ã€‚" },
  { name:"å¤§æš‘",date:"2025-07-22",desc:"ä¸€å¹´æœ€ç†±ï¼Œæ³¨æ„é¤Šç”Ÿã€‚",advice:"ä¿æŒå†·éœï¼Œé©åº¦ä¼‘æ¯èˆ‡éœé¤Šã€‚" },
  { name:"ç«‹ç§‹",date:"2025-08-07",desc:"ç§‹å¤©é–‹å§‹ï¼Œæš‘é€€æ¶¼ä¾†ã€‚",advice:"å¤šè¦ªè¿‘å¤§è‡ªç„¶ï¼Œç·´ç¿’æ„Ÿæ©ã€‚" },
  { name:"è™•æš‘",date:"2025-08-23",desc:"ç‚ç†±æ¼¸é€€ï¼Œæ°£å€™è½‰æ¶¼ã€‚",advice:"å¤šèˆ‡æœ‹å‹èšæœƒï¼Œé¿å…å­¤å¯‚ã€‚" },
  { name:"ç™½éœ²",date:"2025-09-07",desc:"éœ²æ°´æ¼¸ç™½ï¼Œå¤©æ°£è½‰æ¶¼ã€‚",advice:"å®‰æ’çŸ­é€”æ—…è¡Œæˆ–æŠ’ç™¼æƒ…æ„Ÿã€‚" },
  { name:"ç§‹åˆ†",date:"2025-09-23",desc:"æ™å¤œå‡åˆ†ï¼Œèƒ½é‡å¹³è¡¡ã€‚",advice:"ç”¨å†¥æƒ³èˆ‡é‹å‹•èª¿æ•´å…§å¿ƒå¹³è¡¡ã€‚" },
  { name:"å¯’éœ²",date:"2025-10-08",desc:"æ°£æº«ä¸‹é™ï¼Œéœ²æ›´å¯’å†·ã€‚",advice:"å¤šæ›¬å¤ªé™½ï¼Œèˆ‡äººä¿æŒäº’å‹•ã€‚" },
  { name:"éœœé™",date:"2025-10-23",desc:"éœœæ°£åˆé™ï¼Œå†¬æ„æ¼¸æ¿ƒã€‚",advice:"è£œå……ç‡Ÿé¤Šï¼Œå®‰æ’é©åº¦æ´»å‹•ã€‚" },
  { name:"ç«‹å†¬",date:"2025-11-07",desc:"å†¬å­£é–‹å§‹ï¼Œè¬ç‰©æ”¶è—ã€‚",advice:"ä¿æŒç¤¾äº¤ï¼Œé¿å…éåº¦å°é–‰ã€‚" },
  { name:"å°é›ª",date:"2025-11-22",desc:"å¤©å¯’åœ°å‡ï¼Œåˆé›ªå¯è¦‹ã€‚",advice:"å­¸ç¿’å°ç¢ºå¹¸ï¼Œç‡Ÿé€ æº«é¦¨æ°›åœã€‚" },
  { name:"å¤§é›ª",date:"2025-12-07",desc:"é›ªå‹¢æ¼¸å¤§ï¼Œå¯’æ„æ·±é‡ã€‚",advice:"è£œå……æº«ç†±é£Ÿç‰©ï¼Œä¿æŒå¿ƒå¢ƒæº«æš–ã€‚" },
  { name:"å†¬è‡³",date:"2025-12-22",desc:"ç™½æ™æœ€çŸ­ï¼Œé™°æ¥µä¹‹æ™‚ã€‚",advice:"èˆ‡å®¶äººåœ˜èšï¼Œå¢é€²å¿ƒéˆèƒ½é‡ã€‚" },
  { name:"å°å¯’",date:"2026-01-05",desc:"å¯’æ°£æ¼¸æ·±ï¼Œæ³¨æ„ä¿æš–ã€‚",advice:"é©åˆéœæ€ã€è¦åŠƒæ–°å¹´æ–¹å‘ã€‚" },
  { name:"å¤§å¯’",date:"2026-01-20",desc:"ä¸€å¹´æœ€å†·ï¼Œé¤Šç²¾è“„éŠ³ã€‚",advice:"å¤šåšä¼¸å±•èˆ‡é‹å‹•ï¼Œä¿æŒæ´»åŠ›ã€‚" }
];
const todayStr=today.toISOString().split("T")[0];
let current=jieqi[0]; for(let i=0;i<jieqi.length;i++){ if(todayStr>=jieqi[i].date) current=jieqi[i]; }
document.getElementById("season-name").innerText="ğŸŒ¿ ç¯€æ°£ï¼š"+current.name;
document.getElementById("season-desc").innerText=current.desc;
document.getElementById("season-advice").innerText="ğŸ’¡ é¤Šç”Ÿå»ºè­°ï¼š"+current.advice;

// ===== åˆ†æ =====
let chart, latestText="";
async function startAnalysis(){
  let progress=0;const bar=document.getElementById("progress-bar");
  const result=document.getElementById("result");const matchBar=document.getElementById("match-bar");
  const loadingText=document.getElementById("loading-text");
  result.textContent="";loadingText.textContent="åˆ†æä¸­";loadingText.classList.add("loading-dots");
  document.getElementById("download-section").classList.add("hidden");

  const apiUrl=window.location.hostname.includes("vercel.app")?"/api/analyze":"https://love.vercel.app/api/analyze";

  const interval=setInterval(()=>{
    if(progress>=100){
      clearInterval(interval);loadingText.textContent="";
      fetch(apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({
        aBeast:aBeast.value,aKin:aKin.value,aBranch:aBranch.value,
        bBeast:bBeast.value,bKin:bKin.value,bBranch:bBranch.value,
        yearGanZhi:window.lunarData?.yearGanZhi||"æœªçŸ¥",
        monthGanZhi:window.lunarData?.monthGanZhi||"æœªçŸ¥",
        dayGanZhi:window.lunarData?.dayGanZhi||"æœªçŸ¥"
      })})
      .then(res=>res.json()).then(data=>{
        const score=data.match??Math.floor(Math.random()*101);
        matchBar.style.width=score+"%";matchBar.textContent=score+"%";
        matchBar.className="h-4 rounded-full text-xs text-white text-right pr-2 "+(score>=80?"bg-green-500":score>=50?"bg-yellow-500":"bg-red-500");
        latestText=data.text||"âš ï¸ æ²’æœ‰æ”¶åˆ°åˆ†æå…§å®¹";
        result.innerHTML=`<p class="font-semibold">ğŸ“… èµ·å¦æ—¥æœŸï¼š${window.lunarData?.lunarText||""}ï¼ˆ${window.lunarData?.yearGanZhi}å¹´ ${window.lunarData?.monthGanZhi}æœˆ ${window.lunarData?.dayGanZhi}æ—¥ï¼‰</p><div class="mt-2">${latestText}</div>`;
        if(chart)chart.destroy();
        chart=new Chart(loveChart,{type:"radar",data:{labels:["æƒ…æ…¾(ç«)","æƒ…æ„Ÿ(æ°´)","æ§åˆ¶(åœŸ)","å†’éšª(é‡‘)","å‰µæ„(æœ¨)"],datasets:[{label:"æ€§æ„›èƒ½é‡",data:data.scores||[20,20,20,20,20],backgroundColor:"rgba(255,99,132,0.2)",borderColor:"rgb(255,99,132)"}]}});
        if(score>=80){playAudio("success-audio");confetti({particleCount:200,spread:100,origin:{y:0.6}});}else if(score<=40){playAudio("fail-audio");}
        document.getElementById("download-section").classList.remove("hidden");
      }).catch(err=>{result.textContent="âŒ åˆ†æå¤±æ•—ï¼š"+err.message;});
    }else{progress++;bar.style.width=progress+"%";bar.textContent=progress+"%";}
  },40);
}
function playAudio(id){const audio=document.getElementById(id);if(audio){audio.currentTime=0;audio.play();}}

downloadWord.addEventListener("click",()=>{const blob=window.htmlDocx.asBlob("<html><body>"+latestText+"</body></html>");const link=document.createElement("a");link.href=URL.createObjectURL(blob);link.download="æ€§æ„›åˆ†æ.docx";link.click();});
downloadPdf.addEventListener("click",()=>{const {jsPDF}=window.jspdf;const doc=new jsPDF();doc.text(latestText.replace(/## /g,"").replace(/\n/g,"\n"),10,10);doc.save("æ€§æ„›åˆ†æ.pdf");});
</script>
</body>
</html>
