<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>感情卜卦分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body class="bg-gradient-to-b from-pink-50 to-orange-50 text-gray-800 min-h-screen flex flex-col items-center py-10">

  <h1 class="text-4xl font-extrabold text-pink-700 mb-8">💖 感情卜卦分析</h1>

  <!-- 月支日支選擇 -->
  <div class="flex gap-6 mb-6">
    <div>
      <label class="block text-gray-700 font-bold mb-2">月支：</label>
      <select id="month-branch" class="p-2 border rounded">
        <option>子</option><option>丑</option><option>寅</option><option>卯</option>
        <option>辰</option><option>巳</option><option>午</option><option>未</option>
        <option>申</option><option>酉</option><option>戌</option><option>亥</option>
      </select>
    </div>
    <div>
      <label class="block text-gray-700 font-bold mb-2">日支：</label>
      <select id="day-branch" class="p-2 border rounded">
        <option>子</option><option>丑</option><option>寅</option><option>卯</option>
        <option>辰</option><option>巳</option><option>午</option><option>未</option>
        <option>申</option><option>酉</option><option>戌</option><option>亥</option>
      </select>
    </div>
  </div>

  <!-- 分析按鈕 -->
  <button id="analyze-btn" class="px-8 py-4 rounded-2xl bg-pink-500 text-white text-lg shadow-md hover:bg-pink-600 transition">
    🚀 開始分析
  </button>

  <!-- 農民曆資訊卡 -->
  <div class="w-3/4 bg-white rounded-xl shadow p-4 mt-8">
    <h3 class="text-lg font-bold text-pink-600 mb-2">📅 農民曆資訊</h3>
    <p id="solar-date" class="text-gray-700"></p>
    <p id="lunar-date" class="text-gray-700"></p>
    <p id="gan-zhi" class="text-gray-700 font-semibold"></p>
    <p id="season-name" class="text-pink-600 font-semibold mt-2"></p>
    <p id="season-desc" class="text-gray-600"></p>
    <p id="season-advice" class="text-green-700"></p>
  </div>

  <!-- 分析進度 -->
  <div id="progress-box" class="w-3/4 mt-10 hidden">
    <p class="text-lg font-bold text-pink-700 mb-2">分析中...</p>
    <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
      <div id="progress-bar" class="bg-pink-500 h-6 text-white text-sm flex items-center justify-center" style="width:0%">0%</div>
    </div>
  </div>

  <!-- 結果區 -->
  <div id="result-box" class="w-3/4 mt-10 hidden">
    <h2 class="text-2xl font-bold text-pink-700 mb-4">🔮 分析結果</h2>
    <p id="result-text" class="text-gray-800 leading-relaxed mb-6"></p>

    <!-- 下載按鈕 -->
    <div class="flex gap-4">
      <button onclick="downloadFile('pdf')" class="px-6 py-3 bg-green-500 text-white rounded-lg shadow hover:bg-green-600">下載 PDF</button>
      <button onclick="downloadFile('word')" class="px-6 py-3 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600">下載 Word</button>
    </div>
  </div>

  <!-- 歡呼聲 -->
  <audio id="cheer-sound" src="https://actions.google.com/sounds/v1/crowds/cheer.ogg"></audio>

  <script>
    // -------------------------
    // 1. 農曆 + 干支 + 節氣
    // -------------------------
    async function fetchLunarDate(y, m, d){
      try{
        const r = await fetch(`https://lunar-calendar-api.netlify.app/v0/2/g2l?y=${y}&m=${m}&d=${d}&z=8&lang=zh`);
        const data = await r.json();

        document.getElementById("solar-date").innerText = `國曆：${y}年${m}月${d}日`;
        document.getElementById("lunar-date").innerText = "農曆：" + data.text;

        const match = data.text.match(/(.{2}年)(.{2}月)?(.{2}日)?/);
        let yearGanZhi = match && match[1] ? match[1].replace("年","") : "未知";
        let monthGanZhi = match && match[2] ? match[2].replace("月","") : "未知";
        let dayGanZhi = match && match[3] ? match[3].replace("日","") : "未知";

        document.getElementById("gan-zhi").innerText =
          `干支：${yearGanZhi}年 ${monthGanZhi}月 ${dayGanZhi}日`;

      }catch(err){
        document.getElementById("solar-date").innerText = `國曆：${y}年${m}月${d}日`;
        document.getElementById("lunar-date").innerText = `農曆：讀取失敗`;
        document.getElementById("gan-zhi").innerText = "干支：甲子年 甲子月 甲子日";
      }
    }

    const today = new Date();
    fetchLunarDate(today.getFullYear(), today.getMonth()+1, today.getDate());

    // -------------------------
    // 2. 分析流程
    // -------------------------
    document.getElementById("analyze-btn").addEventListener("click", async () => {
      document.getElementById("progress-box").classList.remove("hidden");
      let bar = document.getElementById("progress-bar");
      let progress = 0;

      const interval = setInterval(() => {
        progress += 5;
        if(progress > 100) progress = 100;
        bar.style.width = progress + "%";
        bar.innerText = progress + "%";
      }, 200);

      // 模擬 API 分析
      setTimeout(() => {
        clearInterval(interval);
        document.getElementById("progress-box").classList.add("hidden");
        document.getElementById("result-box").classList.remove("hidden");

        const score = Math.floor(Math.random()*100);
        document.getElementById("result-text").innerText =
          `契合度：${score}%\n這段關係的能量顯示出...（示範文字）`;

        if(score > 80){
          confetti();
          document.getElementById("cheer-sound").play();
        }
      }, 4000);
    });

    // -------------------------
    // 3. 匯出 PDF / Word
    // -------------------------
    function downloadFile(type){
      const text = document.getElementById("result-text").innerText;
      if(type === "pdf"){
        const blob = new Blob([text], {type:"application/pdf"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "分析結果.pdf";
        link.click();
      }else{
        const blob = new Blob([text], {type:"application/msword"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "分析結果.doc";
        link.click();
      }
    }
  </script>
</body>
</html>
