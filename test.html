<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>神獸人格 × 性愛五行中庸分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="p-6 bg-gray-50">

  <h1 class="text-3xl font-bold text-center text-red-600 mb-6">AI 劇本分析</h1>

  <!-- A方 -->
  <div class="mb-4">
    <h2>A方</h2>
    <select id="aBeast"></select>
    <select id="aKin"></select>
    <select id="aBranch"></select>
  </div>

  <!-- B方 -->
  <div class="mb-4">
    <h2>B方</h2>
    <select id="bBeast"></select>
    <select id="bKin"></select>
    <select id="bBranch"></select>
  </div>

  <!-- 日月支 -->
  <div class="mb-4">
    <label>日支 <select id="dayBranch"></select></label>
    <label>月支 <select id="monthBranch"></select></label>
  </div>

  <button id="analyzeBtn" class="bg-red-600 text-white px-4 py-2 rounded">開始分析</button>

  <!-- 結果 -->
  <div id="result" class="mt-6 hidden">
    <canvas id="loveChart" width="400" height="400"></canvas>
    <div id="analysisText" class="mt-4 p-3 bg-white shadow rounded prose max-w-none"></div>
  </div>

  <script>
    const beasts=["青龍","朱雀","勾陳","螣蛇","白虎","玄武"];
    const kins=["父母","兄弟","妻財","官鬼","子孫","應位"];
    const branch=["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];

    function fill(sel,arr){ sel.innerHTML=arr.map(x=>`<option>${x}</option>`).join(""); }
    fill(aBeast,beasts); fill(bBeast,beasts);
    fill(aKin,kins); fill(bKin,kins);
    fill(aBranch,branch); fill(bBranch,branch);
    fill(dayBranch,branch); fill(monthBranch,branch);

    let chart;

    document.getElementById("analyzeBtn").addEventListener("click", async ()=>{
      const payload = {
        aBeast: aBeast.value, aKin: aKin.value, aBranch: aBranch.value,
        bBeast: bBeast.value, bKin: bKin.value, bBranch: bBranch.value,
        dayBranch: dayBranch.value, monthBranch: monthBranch.value
      };

      try {
        const res = await fetch("/api/analyze", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error("API 錯誤: " + text);
        }

        const data = await res.json();

        document.getElementById("result").classList.remove("hidden");
        document.getElementById("analysisText").innerHTML = marked.parse(data.text);

        if(chart) chart.destroy();
        chart = new Chart(document.getElementById("loveChart"),{
          type:"radar",
          data:{ labels:["情慾(火)","情感(水)","控制(土)","冒險(金)","創意(木)"],
            datasets:[{ label:"性愛能量", data:data.scores,
              backgroundColor:"rgba(255,99,132,0.2)", borderColor:"rgb(255,99,132)" }] }
        });

      } catch(err){
        alert(err.message);
        console.error(err);
      }
    });
  </script>
</body>
</html>
