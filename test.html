<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>18ç¦å¥‘åˆåº¦æ¸¬è©¦</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.1/html-docx.js"></script>
</head>
<body class="bg-gradient-to-b from-gray-50 to-pink-100 text-gray-800 min-h-screen flex flex-col items-center py-10">

  <h1 class="text-3xl font-bold text-pink-700 mb-6">ğŸ”® å¥‘åˆåº¦åˆ†æç³»çµ±</h1>

  <!-- A æ–¹ / B æ–¹ -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 w-3/4">
    <div class="p-4 bg-white rounded-xl shadow">
      <h2 class="font-bold text-lg mb-2 text-pink-600">A æ–¹</h2>
      <select id="aBeast" class="w-full border p-2 rounded mb-2">
        <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
        <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
      </select>
      <select id="aKin" class="w-full border p-2 rounded mb-2">
        <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å¦»è²¡</option>
        <option>å®˜é¬¼</option><option>å­å­«</option>
      </select>
      <select id="aBranch" class="w-full border p-2 rounded"></select>
    </div>

    <div class="p-4 bg-white rounded-xl shadow">
      <h2 class="font-bold text-lg mb-2 text-pink-600">B æ–¹</h2>
      <select id="bBeast" class="w-full border p-2 rounded mb-2">
        <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
        <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
      </select>
      <select id="bKin" class="w-full border p-2 rounded mb-2">
        <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å¦»è²¡</option>
        <option>å®˜é¬¼</option><option>å­å­«</option>
      </select>
      <select id="bBranch" class="w-full border p-2 rounded"></select>
    </div>
  </div>

  <!-- æ—¥æœˆæ”¯ -->
  <div class="flex gap-4 mb-6">
    <div>
      <label class="font-bold">æ—¥æ”¯ï¼š</label>
      <select id="dayBranch" class="border p-2 rounded"></select>
    </div>
    <div>
      <label class="font-bold">æœˆæ”¯ï¼š</label>
      <select id="monthBranch" class="border p-2 rounded"></select>
    </div>
  </div>

  <!-- è¾²æ°‘æ›† -->
  <div class="w-3/4 p-4 bg-white rounded-xl shadow mb-6">
    <h2 id="season-name" class="text-xl font-bold text-pink-600 mb-2">ğŸŒ¿ ä»Šæ—¥ç¯€æ°£</h2>
    <p id="today-date" class="text-gray-700"></p>
    <p id="lunar-date" class="text-gray-700"></p>
    <p id="season-desc" class="text-gray-600 mt-2"></p>
    <p id="mood" class="text-pink-600 mt-2"></p>
    <p id="advice" class="text-gray-600 mt-2"></p>
    <p id="next-season" class="text-gray-500 mt-2"></p>
  </div>

  <!-- é€²åº¦æ¢ -->
  <div class="w-3/4 bg-gray-200 rounded-full h-6 mb-4">
    <div id="progress-bar" class="bg-pink-500 h-6 rounded-full text-white text-sm flex items-center justify-center"
         style="width:0%">0%</div>
  </div>

  <!-- å¥‘åˆåº¦ -->
  <div class="w-3/4 bg-white shadow rounded-xl p-4 mb-4">
    <p class="font-bold mb-2">å¥‘åˆåº¦ï¼š</p>
    <div class="w-full bg-gray-200 rounded-full h-4">
      <div id="match-bar" class="bg-green-500 h-4 rounded-full text-xs text-white text-right pr-2">0%</div>
    </div>
  </div>

  <!-- é›·é”åœ– -->
  <div class="w-3/4 bg-white shadow rounded-xl p-4 mb-4">
    <h3 class="font-bold text-pink-600 mb-2">äº”è¡Œèƒ½é‡åœ–</h3>
    <canvas id="loveChart" width="400" height="400"></canvas>
  </div>

  <!-- åˆ†æçµæœ -->
  <div id="result" class="w-3/4 bg-white shadow rounded-xl p-4 text-gray-700"></div>

  <!-- åˆ†ææŒ‰éˆ• -->
  <button onclick="startAnalysis()"
          class="mt-6 px-8 py-4 bg-pink-500 text-white text-lg rounded-2xl shadow hover:bg-pink-600 transition">
    é–‹å§‹åˆ†æ
  </button>

  <!-- ä¸‹è¼‰æŒ‰éˆ•ï¼ˆåˆå§‹éš±è—ï¼‰ -->
  <div id="download-section" class="mt-4 hidden flex gap-4">
    <button id="downloadWord" class="px-4 py-2 bg-blue-500 text-white rounded">ğŸ“„ ä¸‹è¼‰ Word</button>
    <button id="downloadPdf" class="px-4 py-2 bg-green-600 text-white rounded">ğŸ“• ä¸‹è¼‰ PDF</button>
  </div>

  <!-- è²éŸ³æ’­æ”¾å™¨ -->
  <audio id="success-audio" hidden>
    <source src="pic/success.mp3" type="audio/mpeg">
  </audio>
  <audio id="fail-audio" hidden>
    <source src="pic/fail.mp3" type="audio/mpeg">
  </audio>

  <script>
    const branches = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
    function fillSelect(id, arr){ const sel=document.getElementById(id); sel.innerHTML=arr.map(x=>`<option>${x}</option>`).join(""); }
    fillSelect("aBranch", branches);
    fillSelect("bBranch", branches);
    fillSelect("dayBranch", branches);
    fillSelect("monthBranch", branches);

    // é è¨­ä»Šå¤©çš„æ—¥æ”¯ã€æœˆæ”¯
    const today = new Date();
    const monthIndex = today.getMonth() % 12;
    const dayIndex = today.getDate() % 12;
    document.getElementById("dayBranch").value = branches[dayIndex];
    document.getElementById("monthBranch").value = branches[monthIndex];

    let chart, latestText = "";

    // åˆ†ææµç¨‹
    async function startAnalysis() {
      let progress = 0;
      const bar = document.getElementById("progress-bar");
      const result = document.getElementById("result");
      const matchBar = document.getElementById("match-bar");

      result.textContent = "æ­£åœ¨åˆ†æä¸­...";
      document.getElementById("download-section").classList.add("hidden");

      const interval = setInterval(() => {
        if (progress >= 100) {
          clearInterval(interval);

          fetch("/api/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              aBeast: document.getElementById("aBeast").value,
              aKin: document.getElementById("aKin").value,
              aBranch: document.getElementById("aBranch").value,
              bBeast: document.getElementById("bBeast").value,
              bKin: document.getElementById("bKin").value,
              bBranch: document.getElementById("bBranch").value,
              dayBranch: document.getElementById("dayBranch").value,
              monthBranch: document.getElementById("monthBranch").value
            })
          })
          .then(res => res.json())
          .then(data => {
            const score = data.match ?? Math.floor(Math.random()*101);

            // å¥‘åˆåº¦
            matchBar.style.width = score + "%";
            matchBar.textContent = score + "%";
            matchBar.className = "h-4 rounded-full text-xs text-white text-right pr-2 " +
              (score >= 80 ? "bg-green-500" : score >= 50 ? "bg-yellow-500" : "bg-red-500");

            // åˆ†ææ–‡å­—
            latestText = data.text || "âš ï¸ æ²’æœ‰æ”¶åˆ°åˆ†æå…§å®¹";
            result.innerHTML = latestText;

            // é›·é”åœ–
            if (chart) chart.destroy();
            chart = new Chart(document.getElementById("loveChart"), {
              type: "radar",
              data: {
                labels: ["æƒ…æ…¾(ç«)", "æƒ…æ„Ÿ(æ°´)", "æ§åˆ¶(åœŸ)", "å†’éšª(é‡‘)", "å‰µæ„(æœ¨)"],
                datasets: [{
                  label: "æ€§æ„›èƒ½é‡",
                  data: data.scores || [20,20,20,20,20],
                  backgroundColor: "rgba(255,99,132,0.2)",
                  borderColor: "rgb(255,99,132)"
                }]
              }
            });

            // å½©å¸¶ + è²éŸ³
            if (score >= 80) {
              playAudio("success-audio");
              confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            } else if (score <= 40) {
              playAudio("fail-audio");
            }

            // é¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•
            document.getElementById("download-section").classList.remove("hidden");
          })
          .catch(err => {
            result.textContent = "âŒ åˆ†æå¤±æ•—ï¼š" + err.message;
          });

        } else {
          progress++;
          bar.style.width = progress + "%";
          bar.textContent = progress + "%";
        }
      }, 40);
    }

    // æ’­æ”¾éŸ³æ•ˆ
    function playAudio(id){ const audio=document.getElementById(id); if(audio){ audio.currentTime=0; audio.play(); } }

    // Word / PDF ä¸‹è¼‰
    document.getElementById("downloadWord").addEventListener("click", ()=>{
      const blob = window.htmlDocx.asBlob("<html><body>"+latestText+"</body></html>");
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download="æ€§æ„›åˆ†æ.docx";
      link.click();
    });
    document.getElementById("downloadPdf").addEventListener("click", ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(latestText.replace(/## /g,"").replace(/\n/g,"\n"), 10, 10);
      doc.save("æ€§æ„›åˆ†æ.pdf");
    });

    // ====== è¾²æ°‘æ›† ======
    async function fetchLunarPrimary(y,m,d){
      const url=`https://lunar-calendar-api.netlify.app/v0/2/g2l?y=${y}&m=${m}&d=${d}&z=8&lang=zh`;
      const r=await fetch(url); if(!r.ok) throw new Error(); return await r.json();
    }
    async function fetchLunarBackup(y,m,d){
      const url=`https://www.sojson.com/open/api/lunar/json.shtml?date=${y}-${m}-${d}`;
      const r=await fetch(url); if(!r.ok) throw new Error(); return await r.json();
    }
    async function fetchLunarDate(y,m,d){
      try{const data=await fetchLunarPrimary(y,m,d);
        document.getElementById("lunar-date").innerText="è¾²æ›†ï¼š"+data.text;
      }catch(err){
        try{const b=await fetchLunarBackup(y,m,d);
          document.getElementById("lunar-date").innerText="è¾²æ›†ï¼š"+b.data.cnmonth+b.data.cnday;
        }catch{document.getElementById("lunar-date").innerText=`è¾²æ›†ï¼š${y}å¹´${m}æœˆ${d}æ—¥ï¼ˆå‡è³‡æ–™ï¼‰`;}
      }
    }

    // åˆå§‹åŒ–æ—¥æœŸ/ç¯€æ°£
    const yyyy = today.getFullYear();
    const mm = today.getMonth()+1;
    const dd = today.getDate();
    document.getElementById("today-date").innerText = `åœ‹æ›†ï¼š${yyyy}å¹´${mm}æœˆ${dd}æ—¥`;
    fetchLunarDate(yyyy,mm,dd);
    document.getElementById("season-name").innerText = "ğŸŒ¿ ä»Šæ—¥ç¯€æ°£";
    document.getElementById("season-desc").innerText = "ä»Šå¤©èƒ½é‡å¹³è¡¡ï¼Œé©åˆå åœèˆ‡åˆ†æã€‚";
    document.getElementById("mood").innerText = "ğŸ’­ å¿ƒæƒ…å‚¾å‘ï¼šå®œå†·éœã€æ…æ€ã€‚";
    document.getElementById("advice").innerText = "ä¿æŒå¹³è¡¡ï¼Œé¿å…éåº¦å‹ç´¯ã€‚";
    document.getElementById("next-season").innerText = "ğŸ“… ä¸‹ä¸€å€‹ç¯€æ°£ï¼šè‡ªå‹•è¨ˆç®—ä¸­...";
  </script>
</body>
</html>
