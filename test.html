<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ„Ÿæƒ…åœå¦åˆ†æ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body class="bg-gradient-to-b from-pink-50 to-orange-50 text-gray-800 min-h-screen flex flex-col items-center py-10">

  <h1 class="text-4xl font-extrabold text-pink-700 mb-8">ğŸ’– æ„Ÿæƒ…åœå¦åˆ†æ</h1>

  <!-- æœˆæ”¯æ—¥æ”¯é¸æ“‡ -->
  <div class="flex gap-6 mb-6">
    <div>
      <label class="block text-gray-700 font-bold mb-2">æœˆæ”¯ï¼š</label>
      <select id="month-branch" class="p-2 border rounded">
        <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
        <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
        <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
      </select>
    </div>
    <div>
      <label class="block text-gray-700 font-bold mb-2">æ—¥æ”¯ï¼š</label>
      <select id="day-branch" class="p-2 border rounded">
        <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
        <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
        <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
      </select>
    </div>
  </div>

  <!-- åˆ†ææŒ‰éˆ• -->
  <button id="analyze-btn" class="px-8 py-4 rounded-2xl bg-pink-500 text-white text-lg shadow-md hover:bg-pink-600 transition">
    ğŸš€ é–‹å§‹åˆ†æ
  </button>

  <!-- è¾²æ°‘æ›†è³‡è¨Šå¡ -->
  <div class="w-3/4 bg-white rounded-xl shadow p-4 mt-8">
    <h3 class="text-lg font-bold text-pink-600 mb-2">ğŸ“… è¾²æ°‘æ›†è³‡è¨Š</h3>
    <p id="solar-date" class="text-gray-700"></p>
    <p id="lunar-date" class="text-gray-700"></p>
    <p id="gan-zhi" class="text-gray-700 font-semibold"></p>
    <p id="season-name" class="text-pink-600 font-semibold mt-2"></p>
    <p id="season-desc" class="text-gray-600"></p>
    <p id="season-advice" class="text-green-700"></p>
  </div>

  <!-- åˆ†æé€²åº¦ -->
  <div id="progress-box" class="w-3/4 mt-10 hidden">
    <p class="text-lg font-bold text-pink-700 mb-2">åˆ†æä¸­...</p>
    <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
      <div id="progress-bar" class="bg-pink-500 h-6 text-white text-sm flex items-center justify-center" style="width:0%">0%</div>
    </div>
  </div>

  <!-- çµæœå€ -->
  <div id="result-box" class="w-3/4 mt-10 hidden">
    <h2 class="text-2xl font-bold text-pink-700 mb-4">ğŸ”® åˆ†æçµæœ</h2>
    <p id="result-text" class="text-gray-800 leading-relaxed mb-6"></p>

    <!-- ä¸‹è¼‰æŒ‰éˆ• -->
    <div class="flex gap-4">
      <button onclick="downloadFile('pdf')" class="px-6 py-3 bg-green-500 text-white rounded-lg shadow hover:bg-green-600">ä¸‹è¼‰ PDF</button>
      <button onclick="downloadFile('word')" class="px-6 py-3 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600">ä¸‹è¼‰ Word</button>
    </div>
  </div>

  <!-- æ­¡å‘¼è² -->
  <audio id="cheer-sound" src="https://actions.google.com/sounds/v1/crowds/cheer.ogg"></audio>

  <script>
    // -------------------------
    // 1. è¾²æ›† + å¹²æ”¯ + ç¯€æ°£
    // -------------------------
    async function fetchLunarDate(y, m, d){
      try{
        const r = await fetch(`https://lunar-calendar-api.netlify.app/v0/2/g2l?y=${y}&m=${m}&d=${d}&z=8&lang=zh`);
        const data = await r.json();

        document.getElementById("solar-date").innerText = `åœ‹æ›†ï¼š${y}å¹´${m}æœˆ${d}æ—¥`;
        document.getElementById("lunar-date").innerText = "è¾²æ›†ï¼š" + data.text;

        const match = data.text.match(/(.{2}å¹´)(.{2}æœˆ)?(.{2}æ—¥)?/);
        let yearGanZhi = match && match[1] ? match[1].replace("å¹´","") : "æœªçŸ¥";
        let monthGanZhi = match && match[2] ? match[2].replace("æœˆ","") : "æœªçŸ¥";
        let dayGanZhi = match && match[3] ? match[3].replace("æ—¥","") : "æœªçŸ¥";

        document.getElementById("gan-zhi").innerText =
          `å¹²æ”¯ï¼š${yearGanZhi}å¹´ ${monthGanZhi}æœˆ ${dayGanZhi}æ—¥`;

      }catch(err){
        document.getElementById("solar-date").innerText = `åœ‹æ›†ï¼š${y}å¹´${m}æœˆ${d}æ—¥`;
        document.getElementById("lunar-date").innerText = `è¾²æ›†ï¼šè®€å–å¤±æ•—`;
        document.getElementById("gan-zhi").innerText = "å¹²æ”¯ï¼šç”²å­å¹´ ç”²å­æœˆ ç”²å­æ—¥";
      }
    }

    const today = new Date();
    fetchLunarDate(today.getFullYear(), today.getMonth()+1, today.getDate());

    // -------------------------
    // 2. åˆ†ææµç¨‹
    // -------------------------
    document.getElementById("analyze-btn").addEventListener("click", async () => {
      document.getElementById("progress-box").classList.remove("hidden");
      let bar = document.getElementById("progress-bar");
      let progress = 0;

      const interval = setInterval(() => {
        progress += 5;
        if(progress > 100) progress = 100;
        bar.style.width = progress + "%";
        bar.innerText = progress + "%";
      }, 200);

      // æ¨¡æ“¬ API åˆ†æ
      setTimeout(() => {
        clearInterval(interval);
        document.getElementById("progress-box").classList.add("hidden");
        document.getElementById("result-box").classList.remove("hidden");

        const score = Math.floor(Math.random()*100);
        document.getElementById("result-text").innerText =
          `å¥‘åˆåº¦ï¼š${score}%\né€™æ®µé—œä¿‚çš„èƒ½é‡é¡¯ç¤ºå‡º...ï¼ˆç¤ºç¯„æ–‡å­—ï¼‰`;

        if(score > 80){
          confetti();
          document.getElementById("cheer-sound").play();
        }
      }, 4000);
    });

    // -------------------------
    // 3. åŒ¯å‡º PDF / Word
    // -------------------------
    function downloadFile(type){
      const text = document.getElementById("result-text").innerText;
      if(type === "pdf"){
        const blob = new Blob([text], {type:"application/pdf"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "åˆ†æçµæœ.pdf";
        link.click();
      }else{
        const blob = new Blob([text], {type:"application/msword"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "åˆ†æçµæœ.doc";
        link.click();
      }
    }
  </script>
</body>
</html>
